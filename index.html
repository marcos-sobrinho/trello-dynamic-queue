TrelloPowerUp.initialize({
  'board-buttons': function(t, options) {
    return t.board('lists').then(boardData => {
      const listIds = boardData.lists.map(l => l.id);
      return Promise.all(listIds.map(listId => t.cards('id,name,labels,due,shortUrl', listId)));
    }).then(cardsArrays => {
      // Flatten array of arrays
      const allCards = [].concat(...cardsArrays);
      console.log("Cards fetched:", allCards);

      const jsonData = allCards.map(c => ({
        name: c.name,
        due: c.due,
        labels: c.labels.map(l => l.name),
        url: c.shortUrl,
        board: options.board.id
      }));

      console.log("Sending JSON to Apps Script:", jsonData);

      fetch('https://script.google.com/macros/s/AKfycbxm--aVDnHHhospao_ct4WAOio5Myvsj51MnhGrBZ-2A5wXUTbCtZl8qkRch5_n6XJ39Q/exec', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(jsonData)
      })
      .then(response => {
        if(response.ok) console.log("JSON sent to Apps Script successfully!");
        else console.error("Failed to send JSON:", response.status, response.statusText);
      })
      .catch(err => console.error("Fetch error:", err));

      return [];
    });
  }
});
