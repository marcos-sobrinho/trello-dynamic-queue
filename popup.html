<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trello Dynamic Queue — Popup</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, 14px; padding: 12px; }
    #status { margin: 8px 0; white-space: pre-wrap; }
    button { padding: 8px 12px; font-size: 14px; margin-right: 8px; }
  </style>
</head>
<body>
  <h3>Dynamic Queue — Sync</h3>
  <div id="status">Ready.</div>
  <button id="syncBtn">Sync Now</button>
  <button id="closeBtn">Close</button>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxm--aVDnHHhospao_ct4WAOio5Myvsj51MnhGrBZ-2A5wXUTbCtZl8qkRch5_n6XJ39Q/exec";

const statusEl = () => document.getElementById('status');

function setStatus(msg) {
  statusEl().textContent = msg;
  console.log(msg);
}

document.addEventListener('DOMContentLoaded', async () => {
  const t = TrelloPowerUp.iframe();

  // Wire buttons
  document.getElementById('syncBtn').addEventListener('click', async () => {
    document.getElementById('syncBtn').disabled = true;
    await runSync(t);
    document.getElementById('syncBtn').disabled = false;
  });

  document.getElementById('closeBtn').addEventListener('click', () => t.closePopup());
});

function getVirtualDueDays(labels, due) {
  if (due) return new Date(due); // real due date takes priority

  if (!labels || labels.length === 0) {
    const dt = new Date();
    dt.setDate(dt.getDate() + 45);
    return dt;
  }

  if (labels.includes('Red')) {
    const dt = new Date();
    dt.setDate(dt.getDate() + 3);
    return dt;
  }
  if (labels.includes('Yellow')) {
    const dt = new Date();
    dt.setDate(dt.getDate() + 7);
    return dt;
  }
  if (labels.includes('Green')) {
    const dt = new Date();
    dt.setDate(dt.getDate() + 20);
    return dt;
  }

  const dt = new Date();
  dt.setDate(dt.getDate() + 45);
  return dt;
}

function computeUrgency(labelDays, dueDate) {
  const now = new Date();
  const diffMs = dueDate - now;
  const diffDays = diffMs / (1000*60*60*24);
  const timeFactor = 1 / Math.max(diffDays, 0.1);

  let subj = 0;
  if (labelDays === 3) subj = 3;
  else if (labelDays === 7) subj = 2;
  else if (labelDays === 20) subj = 1;
  else subj = 0;

  return (subj + timeFactor) / 2;
}

async function runSync(t) {
  try {
    setStatus('Fetching cards from board...');
    const cards = await t.cards('all');

    if (!cards || cards.length === 0) {
      setStatus('No cards found on this board.');
      return;
    }

    const jsonData = cards.map(c => {
      const virtualDue = getVirtualDueDays(c.labels, c.due);
      
      let labelDays = 45;
      if (c.labels.includes('Red')) labelDays = 3;
      else if (c.labels.includes('Yellow')) labelDays = 7;
      else if (c.labels.includes('Green')) labelDays = 20;

      const urgency = computeUrgency(labelDays, virtualDue);

      return {
        id: c.id,
        name: c.name,
        due: c.due || null,
        virtualDue: virtualDue.toISOString(),
        labels: (c.labels || []).map(l => l.name),
        url: c.shortUrl,
        urgencyScore: urgency
      };
    });

    // sort by urgency descending
    jsonData.sort((a,b) => b.urgencyScore - a.urgencyScore);

    console.log('Prepared JSON with urgency:', jsonData);
    setStatus(`Total cards fetched: ${jsonData.length}\nSending to Apps Script...`);

    const resp = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(jsonData)
    });

    if (!resp.ok) {
      setStatus('Apps Script returned HTTP ' + resp.status);
      console.error('Apps Script response', resp);
      return;
    }

    const text = await resp.text();
    console.log('Apps Script response:', text);
    setStatus(`Sync successful! (${jsonData.length} cards sent)`);

    setTimeout(() => t.closePopup(), 900);

  } catch (err) {
    setStatus('Sync error: ' + (err.message || err));
    console.error(err);
  }
}
</script>
</body>
</html>
