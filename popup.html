<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trello Dynamic Queue</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    #status { margin-bottom: 10px; color: #333; }
    button { padding: 6px 12px; margin-top: 10px; }
  </style>
</head>
<body>
  <div id="status">Initializing...</div>
  <button id="syncButton">Sync Queue Now</button>

  <script>
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxm--aVDnHHhospao_ct4WAOio5Myvsj51MnhGrBZ-2A5wXUTbCtZl8qkRch5_n6XJ39Q/exec"; // replace with your web app URL

    const statusEl = document.getElementById("status");
    const syncButton = document.getElementById("syncButton");

    // Replace with your real urgency calculation function
    function calculateUrgency(card) {
      let score = 0;
      if (card.labels.includes("High")) score += 5;
      if (card.labels.includes("Medium")) score += 3;
      if (card.labels.includes("Low")) score += 1;

      // Simple date-based scoring: closer due date â†’ higher urgency
      const due = card.due ? new Date(card.due) : new Date(Date.now() + 45*24*60*60*1000);
      const daysLeft = (due - new Date()) / (1000*60*60*24);
      score += Math.max(0, 20 - daysLeft); // scales urgency as due date approaches
      return score;
    }

    async function fetchTrelloQueue(cardsData, retries = 3, delayMs = 2000) {
      for (let attempt = 1; attempt <= retries; attempt++) {
        try {
          const response = await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            mode: "cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(cardsData)
          });

          if (!response.ok) throw new Error(`Server responded with status ${response.status}`);

          const data = await response.json();
          console.log("Apps Script response:", data);

          if (data.status !== "ok") console.warn("Apps Script returned error:", data);
          else console.log("Queue successfully synced!");

          statusEl.textContent = `Queue synced! ${cardsData.length} cards processed.`;
          return data;

        } catch (err) {
          console.error(`Attempt ${attempt} failed:`, err);

          if (attempt < retries) {
            console.log(`Retrying in ${delayMs/1000}s...`);
            statusEl.textContent = `Retrying... (Attempt ${attempt})`;
            await new Promise(resolve => setTimeout(resolve, delayMs));
          } else {
            statusEl.textContent = `Failed to sync queue after ${retries} attempts`;
            alert(`Error syncing Trello queue: ${err.message}`);
          }
        }
      }
    }

    async function syncQueue() {
      statusEl.textContent = "Fetching cards from Trello...";
      try {
        const t = TrelloPowerUp.iframe();
        const cards = await t.cards('all');

        if (!cards || !cards.length) {
          statusEl.textContent = "No cards found on board.";
          return;
        }

        // Calculate urgency score for each card
        cards.forEach(c => {
          c.urgencyScore = calculateUrgency(c);
        });

        // Send to Google Apps Script
        await fetchTrelloQueue(cards);

      } catch (err) {
        console.error("Error fetching Trello cards:", err);
        statusEl.textContent = "Failed to fetch cards from Trello.";
      }
    }

    // Initial sync
    syncQueue();

    // Button to manually trigger sync
    syncButton.addEventListener('click', syncQueue);

  </script>
</body>
</html>
